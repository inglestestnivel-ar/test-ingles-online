const SHEET_ID = '1139kYkeb6nHIIoUjk7AkRAaVCxzD0PRaH4Rx7ih8HTM';

const COLUMN_MAP = {
  id: 0,
  nivel: 1,
  tipo: 2,
  pregunta: 3,
  opciones: 4,
  respuestacorrecta: 5,
  dificultad: 6,
  puntos: 7,
  tema: 8,
  habilidad: 9
};

const sheetCache = {};

function doGet(e) {
  return handleRequest(e, "GET");
}

function doPost(e) {
  return handleRequest(e, "POST");
}

function handleRequest(e, method) {
  try {
    if (!e) {
      console.error("üö® [ERROR] Par√°metro 'e' no proporcionado");
      return errorResponse("Error interno");
    }

    let params = {};
    if (method === "GET") {
      params = e.parameter;
    } else if (method === "POST") {
      try {
        params = JSON.parse(e.postData.contents);
      } catch (err) {
        console.error("üö® [PARSE] Error al parsear JSON:", err);
        return errorResponse("Formato inv√°lido");
      }
    }

    const action = (params.action || "").trim().toLowerCase();
    console.log(`üì• [${method}] Acci√≥n: '${action}'`, params);

    switch (action) {
      case "getinitialquestion":
      case "getnextquestion":
        const level = params.level || "A1";
        const isHard = action === "getinitialquestion";
        return getQuestionByDifficulty(level, isHard ? 5 : null, params.usedIds);
      case "validateanswer":
        return validateAnswer(params.id, params.answer);
      case "savelead":
        return saveLead(params);
      case "sendresults":
        return sendResults(params);
      default:
        return errorResponse("Acci√≥n no v√°lida");
    }
  } catch (err) {
    console.error("üö® [ERROR GLOBAL] en handleRequest:", err);
    return errorResponse("Error interno del servidor");
  }
}

function getQuestionByDifficulty(level, targetDifficulty, usedIdsStr) {
  try {
    const ss = SpreadsheetApp.openById(SHEET_ID);
    const sheet = ss.getSheetByName(level);
    if (!sheet) return errorResponse(`Nivel no encontrado: ${level}`);

    const data = sheet.getDataRange().getValues();
    if (data.length < 2) return errorResponse("No hay preguntas disponibles");

    const headers = data[0];
    const colIndex = {};
    headers.forEach((h, i) => {
      colIndex[(h || "").toString().trim().toLowerCase()] = i;
    });

    const required = ["id", "pregunta", "respuestacorrecta", "puntos"];
    for (const col of required) {
      if (colIndex[col] === undefined) {
        return errorResponse(`Falta columna: '${col}'`);
      }
    }

    let questionPool = data.slice(1).filter(row => {
      const diff = Number(row[colIndex["dificultad"]]) || 0;
      return targetDifficulty !== null ? diff === targetDifficulty : diff < 5;
    });

    let usedIds = [];
    try {
      usedIds = JSON.parse(usedIdsStr || "[]").map(id => id.toUpperCase());
    } catch (e) {
      console.warn("‚ö†Ô∏è No se pudo parsear usedIds");
    }

    questionPool = questionPool.filter(row => {
      const id = String(row[colIndex["id"]]).trim().toUpperCase();
      return !usedIds.includes(id);
    });

    if (questionPool.length === 0) {
      return errorResponse("No hay m√°s preguntas disponibles");
    }

    const randomRow = questionPool[Math.floor(Math.random() * questionPool.length)];
    const question = {};
    headers.forEach((header, index) => {
      const key = (header || "").toString().trim();
      question[key] = randomRow[index] !== null ? randomRow[index].toString() : "";
    });

    question.ID = (question.ID || "").trim().toUpperCase();

    console.log("‚úÖ [GET] Pregunta cargada:", question.ID);
    return ContentService.createTextOutput(JSON.stringify(question))
                        .setMimeType(ContentService.MimeType.JSON);
  } catch (err) {
    console.error("üö® [ERROR] getQuestionByDifficulty:", err);
    return errorResponse("Error al obtener pregunta");
  }
}

function validateAnswer(id, userAnswer) {
  try {
    if (!id || !userAnswer) return errorResponse("ID o respuesta faltante");

    const questionId = String(id).trim().toUpperCase();
    const level = questionId.split('-')[0];
    const userInput = normalizeText(userAnswer);

    const ss = SpreadsheetApp.openById(SHEET_ID);
    const sheet = ss.getSheetByName(level);
    if (!sheet) return errorResponse(`Nivel ${level} no encontrado`);

    const data = sheet.getDataRange().getValues();
    const headers = data[0];
    const colIndex = {};
    headers.forEach((h, i) => {
      colIndex[(h || "").toString().trim().toLowerCase()] = i;
    });

    if (!colIndex["id"] || !colIndex["respuestacorrecta"] || !colIndex["puntos"]) {
      return errorResponse("Columnas faltantes");
    }

    const row = data.slice(1).find(r => {
      const cellId = String(r[colIndex["id"]]).trim().toUpperCase();
      return cellId === questionId;
    });

    if (!row) {
      console.error("‚ùå [ERROR] Pregunta no encontrada:", id);
      return errorResponse("Pregunta no encontrada");
    }

    const correctAnswerValue = String(row[colIndex["respuestacorrecta"]]).trim();
    const correctAnswer = normalizeText(correctAnswerValue);
    const points = Number(row[colIndex["puntos"]]) || 10;

    const isCorrect = 
      userInput === correctAnswer ||
      userInput.includes(correctAnswer) ||
      correctAnswerValue.toLowerCase() === "correcto";

    console.log("‚úÖ [VALID] Resultado:", { id, correct: isCorrect, puntos: isCorrect ? points : 0 });

    return ContentService.createTextOutput(JSON.stringify({
      correct: isCorrect,
      points: isCorrect ? points : 0,
      correctAnswer: correctAnswerValue
    })).setMimeType(ContentService.MimeType.JSON);
  } catch (err) {
    console.error("üö® [ERROR] validateAnswer:", err);
    return errorResponse("Error al validar respuesta");
  }
}

function normalizeText(text) {
  return (text || "")
    .toString()
    .toLowerCase()
    .trim()
    .replace(/\s+/g, ' ')
    .replace(/[.,;:!?]$/, '')
    .replace(/^["']|["']$/g, '');
}

function saveLead(data) {
  try {
    const { nombre, email, pais } = data;
    if (!nombre || !email || !pais) {
      return errorResponse("Campos obligatorios faltantes");
    }

    const ss = SpreadsheetApp.openById(SHEET_ID);
    const sheet = ss.getSheetByName("Leads");
    if (!sheet) return errorResponse("Hoja 'Leads' no encontrada");

    const newRow = [
      new Date(),
      (nombre || "").trim(),
      (email || "").trim().toLowerCase(),
      (data.telefono || "").trim(),
      (pais || "").trim(),
      (data.nivelautoevaluado || "No especificado"),
      (data.motivo || "No especificado"),
      (data.referencia || "No especificado"),
      (data.primerNivelAlcanzado || "No alcanzado"),
      (data.fechaTest || new Date().toLocaleDateString())
    ];

    sheet.appendRow(newRow);
    console.log("‚úÖ [SAVE] Lead guardado:", nombre, email);
    return ContentService.createTextOutput(
      JSON.stringify({ success: true, message: "Lead guardado correctamente" })
    ).setMimeType(ContentService.MimeType.JSON);
  } catch (err) {
    console.error("üö® [ERROR] saveLead:", err);
    return errorResponse("Error al guardar lead");
  }
}

function sendResults(data) {
  try {
    const { nombre, email, nivelFinal, puntajeFinal, errores, sospechosos, answerHistory } = data;

    let historyArray = [];
    try {
      historyArray = typeof answerHistory === "string" ? JSON.parse(answerHistory) : answerHistory;
      if (!Array.isArray(historyArray)) historyArray = [];
    } catch (err) {
      console.error("üö® [PARSE] Error al parsear answerHistory:", err);
    }

    const resumen = generarResumenPorNivel(historyArray);
    const detalle = historyArray.map((q, i) => 
      `${i+1}. [${q.nivel}] ${q.pregunta}\n   Resp: ${q.respuestaUsuario} | Correcta: ${q.correcta ? 'S√≠' : 'No'} | Puntos: ${q.puntaje}`
    ).join("\n\n");

    const cuerpo = `
      üìä **Resultados del Test de Ingl√©s**

      **üë§ Nombre:** ${nombre}
      **üìß Email:** ${email}
      **üéØ Nivel Final:** ${nivelFinal}
      **üìà Puntaje Final:** ${puntajeFinal}
      **‚ùå Errores:** ${errores}
      **üö® Acciones sospechosas:** ${sospechosos}
      **üìÖ Fecha:** ${new Date().toLocaleString()}

      **üìå Resumen por nivel:**
      ${resumen}

      **üìã Historial de respuestas:**
      ${detalle}

      --- 
      Sistema autom√°tico de nivelaci√≥n de ingl√©s.
    `;

    GmailApp.sendEmail("inglestestnivel@gmail.com", `üìã Resultados - ${nombre}`, cuerpo, {
      name: "Test de Ingl√©s"
    });

    console.log("‚úÖ [EMAIL] Resultados enviados");
    return ContentService.createTextOutput(
      JSON.stringify({ success: true, message: "Resultados enviados" })
    ).setMimeType(ContentService.MimeType.JSON);
  } catch (err) {
    console.error("üö® [ERROR] sendResults:", err);
    return errorResponse("Error al enviar resultados");
  }
}

function generarResumenPorNivel(history) {
  const niveles = ["A1", "A2", "B1", "B2", "C1", "C2"];
  return niveles.map(nivel => {
    const preguntas = history.filter(q => q.nivel === nivel);
    if (preguntas.length === 0) return null;
    const correctas = preguntas.filter(q => q.correcta).length;
    return `- ${nivel}: ${correctas}/${preguntas.length}`;
  }).filter(Boolean).join("\n");
}

function errorResponse(message) {
  console.error("‚ùå [ERROR] errorResponse:", message);
  return ContentService.createTextOutput(
    JSON.stringify({ success: false, error: message })
  ).setMimeType(ContentService.MimeType.JSON);
}
